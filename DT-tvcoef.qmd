---
title: "Utilisation de modèles de régression à coefficients variant dans le temps pour la prévision conjoncturelle"
format: 
  pdf:
    include-in-header: preambule.tex
  html: 
    toc: true
    self-contained: true
    include-before-body: preambule.html
toc: true
number-sections: true
lang: fr
language:
 title-block-author-single: Auteur
bibliography: biblio.bib
author:
  - name: Alain Quartier-la-Tente 
    affiliation: Insee
    affiliation-url: https://www.insee.fr/fr/
citation:
  type: article-journal
  container-title: "Document de travail méthodologique Insee"
  issued: 2024
  url: https://github.com/InseeFrLab/DT-tvcoef
---

```{r}
#| include: false
library(tvCoef)
library(dynlm)
library(strucchange)
library(tvReg)
```

# Abstract

Remerciements

# Introduction

Sur longue période, les institutions, les normes de sociétés ainsi que les comportements des agents économiques évoluent, induisant des changements dans la dynamique des séries économiques étudiées.

De nombreux modèles de l'Insee sont basés sur des régressions linéaires (CJO, prévisions, calage...) qui supposent que les relations entre les variables sont fixes dans le temps.


Hypothèse vraie sur le court-terme mais généralement fausse sur le long-terme ou en présence de changements structurels (changement de nomenclature, de définition, COVID...)


Objectifs : 

- étudier des méthodes qui permettent de relâcher cette contrainte ;

- proposer une façon simple d'implémenter et de comparer ces méthodes (package {{< fa brands r-project >}} `tvCoef`)

@JMS2018 et @eurostat2015guidelines


# Modélisation

Dans cet article, nous nous placerons dans le cadre de la régression linéaire avec des variables à une dimension.
À chaque date $t$, une variable à expliquer $y_t$ (e.g. : taux de croissance du PIB) s'écrit comme une combinaison linéaire de $p$ variables explicative, $x_{0,t},\dots,x_{p,t}$ (soldes d'opinion, indices de production industrielle, indicatrices, etc.)  :
$$
y_t=\beta_{0}+\beta_{1} x_{1,t}+\dots+\beta_{p} x_{p,t} +\varepsilon_t 
$$
où $\varepsilon_t$ représente l'erreur.
En notant ${\bf X}_t=\begin{pmatrix}1 \\ x_{1,t} \\\vdots \\ x_{p,t} \end{pmatrix}$ et 
${\bf \beta}=\begin{pmatrix}\beta_0 \\ \beta_1 \\\vdots \\ \beta_p \end{pmatrix}$, cela s'écrit matriciellement\ :
$$
y_t=\transp{\bf\beta} \bf X_t +\varepsilon_t.
$$

Dans le cadre de la régression linéaire, les coefficients $\bf\beta$ sont supposés constants dans le temps et estimés en utilisant l'ensemble des données.
Cela suppose donc que la relation économique entre les différentes variables est stable dans le temps.
Même si cette hypothèse est généralement vraie sur le court-terme, elle peut être invalidée sur le long-terme du fait de changements structurels (mesures économiques, crises, changement de nomenclature, etc.)
L'objectif de cet article est d'étudier différent modèles permettant de relâcher cette hypothèse de constance des coefficients.
Le modèle général s'écrit donc :
$$
y_t=\transp{\bf\beta_t} \bf X_t +\varepsilon_t.
$$

Les différentes méthodes seront illustrées à travers l'exemple de la prévision du taux de croissance trimestriel du PIB à partir du climat des affaires France publié par l'Insee.
Ces séries sont disponibles sous {{< fa brands r-project >}} dans la base de donnée `tvCoef::gdp` :

- `growth_gdp` correspond au taux de croissance trimestriel du PIB ;

- `bc_fr_m1` correspond au climat des affaires au premier mois de chaque trimestre (la valeur de 2000T1 correspond à la valeur de janvier 2000, celle de 2000T2 à celle d'avril 2000, etc.) ;

- `diff_bc_fr_m1` correspond à la différenciation trimestrielle de la variable précédente (la valeur de 2000T1 correspond à la différence du climat des affaires entre de janvier 2000 et octobre 1999).

Le modèle s'écrit donc :
$$
\% PIB_t=\beta_0 + \beta_1\times climat\_fr_t^{m_1} + \beta_2\times \Delta climat\_fr_t^{m_1}+\varepsilon_t.
$$

Il est estimé en utilisant les données entre les années 1990 et 2019.
Sous {{< fa brands r-project >}}, ce modèle peut être estimé en utilisant la fonction `stats::lm()`.
Toutefois, nous recommandons d'utiliser le package `dynlm` @dynlm qui offre une plus grande flexibilité dans la définition des modèles et de conserver le format série temporelle dans les fonctions de `tvCoef`.

```{r}
#| warning: false
#| message: false
library(tvCoef)
library(dynlm)
model_gdp <- dynlm(
  formula = growth_gdp ~ bc_fr_m1 + diff_bc_fr_m1,
  data = window(gdp, start = 1980, end = c(2019,4))
)
# # Equivalent à :
# model_gdp <- dynlm(
#   formula = growth_gdp ~ bc_fr_m1 + diff(bc_fr_m1, 1),
#   # Date de début changée car on perd une donnée avec la différenciation
#   data = window(gdp, start = c(1989,4), end = c(2019,4))
# )
coefficients(model_gdp)
```

Le modèle estimé est donc :
```{r}
#| echo: false
#| output: asis
cat(sprintf("$$\\%% PIB_t=%.2f + %.2f\\times climat\\_fr_t^{m_1} + %.2f\\times \\Delta climat\\_fr_t^{m_1}+\\hat\\varepsilon_t$$",
        coef(model_gdp)[1],
         coef(model_gdp)[2],
         coef(model_gdp)[3]))
```



## Test de rupture brutale

L'idée la plus simple pour tester s'il y a une rupture dans l'estimation des coefficients à une date $t_1$, est d'estimer deux sous-modèles avant et après cette date :

$$
\begin{cases}
\forall t \leq t_1 :\quad PIB_t = \beta_0' + \beta_1' climat\_fr_t + \beta_2' \Delta climat\_fr_t + \varepsilon_t' \\
\forall t > t_1 :\quad PIB_t = \beta_0'' + \beta_1'' climat\_fr_t + \beta_2'' \Delta climat\_fr_t + \varepsilon_t''
\end{cases}
$$
Et ensuite de tester si les coefficients estimés entre les deux sous-périodes sont égaux : $\beta_0' = \beta_0''$, $\beta_1' = \beta_1''$ et $\beta_2' = \beta_2''$.
C'est le principe du test de Chow.

L'inconvénient est que cela suppose d'avoir un a priori sur la date de la rupture à tester.
Pour palier à ce problème, @bai2003computation ont proposé un algorithme efficace afin de chercher la présence de ruptures multiples dans des modèles de régression linéaire.
Sous {{< fa brands r-project >}}, cet algorithme a été implémenté dans le package `strucchange` @strucchangeBP.
La fonction `strucchange::breakpoints()` permet de chercher les ruptures et la fonction `strucchange::breakdates()` d'extraire facilement les dates associées.
Le package `tvCoef` implémente une méthode `breakpoints.lm()` afin de pouvoir directement appliquer cette fonction aux régressions linéaires estimées :

```{r}
#| message: false
#| warning: false
library(strucchange)
breakdates(breakpoints(model_gdp))
```
Une seule rupture est détectée au `r format(zoo::as.yearqtr(2000.25), "%YT%q")`



## Test de constance des coefficients

Les tests classiques supposent qu'il existe une date de rupture, mais on veut parfois juste savoir si le coefficients est constant ou non.


@hansen1992testing



Tests trouvés dans la littérature autour de Nyblom et Hansen -\> Implémentation de Hansen (1992)

Idée : 
$$
f_{i,t} = \begin{cases}
x_{i,t}\hat \varepsilon_t &\text{ si }i\leq p\\
\hat \varepsilon_t^2 - \hat \sigma^2&\text{ si }i=p+1
\end{cases}
\text{ puis }S_{i,t} = \sum_{j=1}^tf_{i,j}\qquad(\text{N.B : }S_{i,n}=0)
$$ 

Test : 
$$
L_i=\frac{1}{nV_i}\sum_{t=1}^nS_{i,t}^2\qquad
\text{avec }V_i=\sum_{t=1}^nf_{i,t}^2
$$ 

Test joint : 
$$
L_c = \frac{1}{n}
\sum_{t=1}^nS_t'V^{-1}S_t\qquad
\text{avec }V=\sum_{t=1}^nf_{t}f_{t}'
$$

Sur notre modèle, le test de Hansen conclut à la non-constance des coefficients associés à la constante et au climat des affaires en niveau.
En revanche, le climat des affaires en différences

```{r}
hansen_test(model_gdp)
```




## Autres tests

@abs2006

# Régression par morceaux

```{r}
pr_gdp <- piece_reg(model_gdp)
coef(pr_gdp$model)
```


# De la régression mobile à la régression locale

@tvReg

# Modélisation espace-état

La modélisation espace-état est une méthodologie générale permettant de traiter un grand nombre de problèmes de séries temporelles.
Dans cette approche, on suppose que tout problème est déterminé par une série de vecteurs non observés $\alpha_1,\dots,\alpha_n$ associés aux observations $y_1,\dots,y_n$, la relation entre $\alpha_t$ et $y_t$ étant spécifiée par le modèle espace-état.
Ces modèles sont largement décrits dans @durbinkoopman.
Dans cet article, nous nous placerons dans un cadre simplifié des modèles linéaires gaussiens.

# Comparaison générale

## Données utilisées


# Conclusion